# -*- coding: utf-8 -*-
"""Deep Learningâ€“Based Facial Emotion Detection Using CNN on FER2013 Dataset.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1-XjJ0lseZeRhyzLaCZfaT6sQq4FTBP_X

##**1.Upload Kaggle API Key**
"""

from google.colab import files
files.upload()   # Upload kaggle.json

"""##**2.Setup Kaggle Configuration**"""

!mkdir -p ~/.kaggle
!cp kaggle.json ~/.kaggle/
!chmod 600 ~/.kaggle/kaggle.json

"""##**3.Download FER2013 Dataset**"""

!kaggle datasets download -d msambare/fer2013

"""##**4.Unzip Dataset**"""

!unzip fer2013.zip -d fer2013

"""##**5.Check Dataset Structure**"""

import os

print(os.listdir('/content/fer2013'))
print(os.listdir('/content/fer2013/train'))
print(os.listdir('/content/fer2013/test'))

"""##**6.Import Required Libraries**"""

from tensorflow.keras.preprocessing.image import ImageDataGenerator
from tensorflow.keras.models import Sequential
from tensorflow.keras.layers import Conv2D, MaxPooling2D, Flatten, Dense, Dropout
from tensorflow.keras.optimizers import Adam
import matplotlib.pyplot as plt

"""##**7.Define Dataset Paths**"""

train_dir = '/content/fer2013/train'
test_dir = '/content/fer2013/test'

"""##**8.Data Preprocessing & Augmentation**"""

train_datagen = ImageDataGenerator(
    rescale=1./255,
    rotation_range=20,
    width_shift_range=0.2,
    height_shift_range=0.2,
    shear_range=0.2,
    zoom_range=0.2,
    horizontal_flip=True
)

test_datagen = ImageDataGenerator(rescale=1./255)

"""##**9.Create Data Generators**"""

train_generator = train_datagen.flow_from_directory(
    train_dir,
    target_size=(48, 48),
    batch_size=64,
    color_mode='grayscale',
    class_mode='categorical'
)

test_generator = test_datagen.flow_from_directory(
    test_dir,
    target_size=(48, 48),
    batch_size=64,
    color_mode='grayscale',
    class_mode='categorical'
)

"""##**10.Build CNN Model**"""

model = Sequential([
    Conv2D(32, (3,3), activation='relu', input_shape=(48,48,1)),
    MaxPooling2D(2,2),

    Conv2D(64, (3,3), activation='relu'),
    MaxPooling2D(2,2),

    Conv2D(128, (3,3), activation='relu'),
    MaxPooling2D(2,2),

    Flatten(),
    Dense(128, activation='relu'),
    Dropout(0.5),
    Dense(7, activation='softmax')
])

"""##**11.Compile Model**"""

model.compile(
    optimizer=Adam(learning_rate=0.0001),
    loss='categorical_crossentropy',
    metrics=['accuracy']
)

"""##**12.Train Model**"""

history = model.fit(
    train_generator,
    epochs=25,
    validation_data=test_generator
)

"""##**13.Save Trained Model**"""

model.save('emotion_detection_cnn.h5')

"""##**14.Evaluate Model**"""

test_loss, test_acc = model.evaluate(test_generator)
print(f"Test Accuracy: {test_acc*100:.2f}%")

"""##**15.Plot Accuracy Graph**"""

plt.plot(history.history['accuracy'], label='Train Accuracy')
plt.plot(history.history['val_accuracy'], label='Validation Accuracy')
plt.legend()
plt.title('Model Accuracy')
plt.show()

"""##**16.Plot Loss Graph**"""

plt.plot(history.history['loss'], label='Train Loss')
plt.plot(history.history['val_loss'], label='Validation Loss')
plt.legend()
plt.title('Model Loss')
plt.show()

"""##**17.Check Sample Test Images**"""

import os
print(os.listdir('/content/fer2013/test/happy'))

"""##**18.Predict Emotion for One Image**"""

from tensorflow.keras.preprocessing import image
import numpy as np

img_path = '/content/fer2013/test/happy/PrivateTest_48134791.jpg' # Changed to an existing image file
img = image.load_img(img_path, target_size=(48,48), color_mode='grayscale')
img_array = image.img_to_array(img)
img_array = img_array / 255.0
img_array = np.expand_dims(img_array, axis=0)

prediction = model.predict(img_array)
predicted_emotion = list(train_generator.class_indices.keys())[np.argmax(prediction)]

plt.imshow(img_array[0].reshape(48,48), cmap='gray')
plt.title(f"Predicted Emotion: {predicted_emotion}")
plt.axis('off')
plt.show()